name: Flutter build (at least one)

on:
  pull_request:
    branches:
      - main
      - develop
      - '**'    # å¿…è¦ãªã‚‰

jobs:
  build:
    runs-on: macos-latest   # iOSãƒ“ãƒ«ãƒ‰ã‚‚è©¦ã—ãŸã„ã®ã§ macOS ã«ã™ã‚‹
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # fvm ã‚’ä½¿ã†ãªã‚‰ã“ã“ã§å…¥ã‚Œã‚‹ï¼ˆ.fvmrc ãŒã‚ã‚‹å‰æï¼‰
      - name: Install FVM
        run: |
          brew install fvm
          fvm --version

      - name: Install Flutter from fvm
        run: |
          fvm install
          fvm flutter --version
          fvm flutter pub get

      # ã©ã¡ã‚‰ã‹ãŒæˆåŠŸã™ã‚Œã°OKã«ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—
      - name: Build apk or ios
        run: |
          set +e

          echo "=== Try Android (apk) build ==="
          fvm flutter build apk
          APK_STATUS=$?

          echo "=== Try iOS build (no codesign) ==="
          fvm flutter build ios --no-codesign
          IOS_STATUS=$?

          echo "Android build exit code: $APK_STATUS"
          echo "iOS build exit code: $IOS_STATUS"

          # ä¸¡æ–¹å¤±æ•—ã—ãŸã‚‰ CI ã‚‚å¤±æ•—ã•ã›ã‚‹
          if [ $APK_STATUS -ne 0 ] && [ $IOS_STATUS -ne 0 ]; then
            echo "Both Flutter builds failed."
            exit 1
          fi

          echo "At least one Flutter build succeeded ğŸ‰"
