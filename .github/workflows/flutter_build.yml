name: Flutter build (at least one)

on:
  pull_request:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Dart ã‚’å…¥ã‚Œã‚‹ï¼ˆmacOSã§ã¯ dart ã˜ã‚ƒãªãã¦ dart-sdkï¼‰
      - name: Install Dart SDK
        run: |
          brew update
          brew install dart-sdk

      # 2. fvm ã‚’ pub ã‹ã‚‰å…¥ã‚Œã‚‹
      - name: Install fvm
        run: |
          dart pub global activate fvm
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH

      # 3. .fvmrc ã«å¾“ã£ã¦ Flutter ã‚’ç”¨æ„
      - name: Setup Flutter via fvm
        run: |
          fvm install
          fvm flutter --version
          fvm flutter pub get

      # 4. ã©ã¡ã‚‰ã‹é€šã‚Œã°OKã«ã™ã‚‹
      - name: Build apk or ios
        run: |
          set +e

          echo "=== Try Android (apk) build ==="
          fvm flutter build apk
          APK_STATUS=$?

          echo "=== Try iOS build (no codesign) ==="
          fvm flutter build ios --no-codesign
          IOS_STATUS=$?

          echo "Android build exit code: $APK_STATUS"
          echo "iOS build exit code: $IOS_STATUS"

          if [ $APK_STATUS -ne 0 ] && [ $IOS_STATUS -ne 0 ]; then
            echo "Both Flutter builds failed."
            exit 1
          fi

          echo "At least one build succeeded ğŸ‰"
